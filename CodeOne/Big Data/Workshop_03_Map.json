{"paragraphs":[{"text":"%md\n# Our First Map - Top 10 Pickup Stations\n\nTo get started, we will plot the 10 top pickup stations on a map.  We will have 1 paragraph which will use Spark and Spark SQL to query our bike_trips table and save the results into an angular variable.  And we will have 1 paragraph that contains the html/javascript to display our map. \n\n+ Run the \"Spark code for our first map\" to gather the data for our map,\n+ Then run the \"HTML/Javascript for our first map\" to display the map with the selected data\n","user":"anonymous","dateUpdated":"2019-08-26T13:42:35+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":"true"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Our First Map - Top 10 Pickup Stations</h1>\n<p>To get started, we will plot the 10 top pickup stations on a map. We will have 1 paragraph which will use Spark and Spark SQL to query our bike_trips table and save the results into an angular variable. And we will have 1 paragraph that contains the html/javascript to display our map. </p>\n<ul>\n  <li>Run the &ldquo;Spark code for our first map&rdquo; to gather the data for our map,</li>\n  <li>Then run the &ldquo;HTML/Javascript for our first map&rdquo; to display the map with the selected data</li>\n</ul>\n</div>"}]},"apps":[],"jobName":"paragraph_1566824983568_594728711","id":"20190826-130943_1943708905","dateCreated":"2019-08-26T13:09:43+0000","dateStarted":"2019-08-26T13:42:35+0000","dateFinished":"2019-08-26T13:42:36+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:174"},{"text":"%spark\n\n\n//a previous tutorial placed the csv file into your Object Store citibike container\n//notice the use of the swift://CONTAINER.default/ syntax\nval Container = \"bigdataprep\"\nval Directory = \"citibike\"\n\nvar df: org.apache.spark.sql.DataFrame = null\n\nprintln(\"Running on OCI\");\ndf = spark.read.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").load(\"oci://bigdataprep@sehubpilot/\"+Directory+\"/raw/201612-citibike-tripdata.csv\")\n\n\n\n// If you get this error message:\n// java.lang.IllegalStateException: Cannot call methods on a stopped SparkContext.\n// Then go to the Settings tab, then click on Notebook.  Then restart the Notebook.  This will restart your SparkContext\n\n\ndf.createOrReplaceTempView(\"bike_trips_temp\")\n\n//Define a class for the structure of the data we will be passing to the map javascript code\ncase class Stations(ridetype: String, station: String, trips: String, lat: Double, lon: Double)\n\n//Unbind angular variable in case it already exists from previous run\nz.angularUnbind(\"topstations\") \n\n//Define a new dataframe based off a query\nval topstationsDF =spark.sql(s\"\"\"select \"Start\" ridetype, `Start Station Name` station,`Start Station Latitude` lat,`Start Station Longitude` lon, count(*) trips from bike_trips_temp \ngroup by `Start Station Name`,`Start Station Latitude`,`Start Station Longitude`\norder by count(*) desc limit 10\"\"\")\n\n\n//Map the DF into an Array of Stations\nvar items = topstationsDF.map(b => Stations(b(0).toString, b(1).toString, \"Pickups:\"+b(4).toString, b(2).toString.toDouble, b(3).toString.toDouble)).collect\n\n//Bind the TopStations (as an Array) to an Angular variable named topstations\nz.angularBind(\"topstations\", items) \n\nprintln(\"..\")\nprintln(\"done\")","user":"anonymous","dateUpdated":"2019-09-09T12:17:56+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nContainer: String = bigdataprep\n\nDirectory: String = citibike\n\ndf: org.apache.spark.sql.DataFrame = null\nRunning on OCI\n\ndf: org.apache.spark.sql.DataFrame = [Trip Duration: string, Start Time: string ... 13 more fields]\n\ndefined class Stations\n\ntopstationsDF: org.apache.spark.sql.DataFrame = [ridetype: string, station: string ... 3 more fields]\n\nitems: Array[Stations] = Array(Stations(Start,Pershing Square North,Pickups:9642,40.751873,-73.977706), Stations(Start,W 21 St & 6 Ave,Pickups:5990,40.74173969,-73.99415556), Stations(Start,E 17 St & Broadway,Pickups:5802,40.73704984,-73.99009296), Stations(Start,Broadway & E 22 St,Pickups:5420,40.7403432,-73.98955109), Stations(Start,Broadway & E 14 St,Pickups:5342,40.73454567,-73.99074142), Stations(Start,8 Ave & W 33 St,Pickups:5282,40.751551,-73.993934), Stations(Start,W 41 St & 8 Ave,Pickups:4963,40.75640548,-73.9900262), Stations(Start,W 52 St & 5 Ave,Pickups:4822,40.75992262,-73.97648516), Stations(Start,Cooper Square & E 7 St,Pickups:4644,40.72923649910006,-73.99086803197861), Stations(Start,8 Ave & W 31 St,Pickups:4622,40.7505853470215,-73.9946848154068))\n..\ndone\n"}]},"apps":[],"jobName":"paragraph_1566825187955_-731994410","id":"20190826-131307_2026087472","dateCreated":"2019-08-26T13:13:07+0000","dateStarted":"2019-09-09T12:17:56+0000","dateFinished":"2019-09-09T12:18:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:175"},{"text":"%md\n\nAbove we query the data from the Object Storage by using Scala and the OCI HDFS Connector. \n\nWe map the Start and Endstations with the corresponding Geo data to the dataframe `topstationsDF` and bind it to angular.\n\nExecute the cell below to display the map. \n","user":"anonymous","dateUpdated":"2019-09-09T12:23:22+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":"true"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1568031567289_-847208409","id":"20190909-121927_612975550","dateCreated":"2019-09-09T12:19:27+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:953","dateFinished":"2019-09-09T12:23:22+0000","dateStarted":"2019-09-09T12:23:22+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>Above we query the data from the Object Storage by using Scala and the OCI HDFS Connector. </p>\n<p>We map the Start and Endstations with the corresponding Geo data to the dataframe <code>topstationsDF</code> and bind it to angular.</p>\n<p>Execute the cell below to display the map.</p>\n</div>"}]}},{"text":"%angular\n<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css\" />\n<div id=\"firstmap\" style=\"height: 600px; width: 100%\"></div>\n\n<script type=\"text/javascript\">\n\n//based on https://gist.github.com/granturing/a09aed4a302a7367be92, https://community.hortonworks.com/articles/90320/add-leaflet-map-to-zeppelin-notebook.html, etc\n\nfunction initMap() {\n    //open up a map around NYC at zoom level 13\n    var map = L.map('firstmap', {preferCanvas: true}).setView([40.75, -73.99], 13);\n\n    //define the background tile layer using OpenStreet maps.  Leaflet can work with other providers, too\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: 'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors',\n        maxZoom: 16,\n        minZoom: 11\n    }).addTo(map);\n\n    var geoMarkers = L.layerGroup().addTo(map);\n    \n    // setup a custom icon for markers. See https://github.com/pointhi/leaflet-color-markers\n    var greenIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n    \n    var redIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n\n    var el = angular.element($('#firstmap').parent('.ng-scope'));\n    angular.element(el).ready(function() {\n        \n        //listen for changes to the angular variable called stations\n        window.locationWatcher = el.scope().compiledScope.$watch('topstations', function(newValue, oldValue) {\n\n            //loop through each entry in our stations variable and add it as a marker\n            angular.forEach(newValue, function(station) {\n                var marker = L.marker([station.lat, station.lon])\n                marker.addTo(geoMarkers);  \n\n            });\n        })\n    });\n}\n\nif (window.locationWatcher) {\n    // clear existing watcher otherwise we'll have duplicates\n    window.locationWatcher();\n}\n\n// ensure we only load the script once, seems to cause issues otherwise\nif (window.L) {\n    initMap();\n} else {\n    console.log('Loading Leaflet library');\n    var sc = document.createElement('script');\n    sc.type = 'text/javascript';\n    sc.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js';\n    sc.onload = initMap;\n    sc.onerror = function(err) { alert(err); }\n    document.getElementsByTagName('head')[0].appendChild(sc);\n}\n</script>\n","user":"anonymous","dateUpdated":"2019-09-09T12:18:07+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":"true"},"editorMode":"ace/mode/undefined","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"ANGULAR","data":"<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css\" />\n<div id=\"firstmap\" style=\"height: 600px; width: 100%\"></div>\n\n<script type=\"text/javascript\">\n\n//based on https://gist.github.com/granturing/a09aed4a302a7367be92, https://community.hortonworks.com/articles/90320/add-leaflet-map-to-zeppelin-notebook.html, etc\n\nfunction initMap() {\n    //open up a map around NYC at zoom level 13\n    var map = L.map('firstmap', {preferCanvas: true}).setView([40.75, -73.99], 13);\n\n    //define the background tile layer using OpenStreet maps.  Leaflet can work with other providers, too\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: 'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors',\n        maxZoom: 16,\n        minZoom: 11\n    }).addTo(map);\n\n    var geoMarkers = L.layerGroup().addTo(map);\n    \n    // setup a custom icon for markers. See https://github.com/pointhi/leaflet-color-markers\n    var greenIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n    \n    var redIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n\n    var el = angular.element($('#firstmap').parent('.ng-scope'));\n    angular.element(el).ready(function() {\n        \n        //listen for changes to the angular variable called stations\n        window.locationWatcher = el.scope().compiledScope.$watch('topstations', function(newValue, oldValue) {\n\n            //loop through each entry in our stations variable and add it as a marker\n            angular.forEach(newValue, function(station) {\n                var marker = L.marker([station.lat, station.lon])\n                marker.addTo(geoMarkers);  \n\n            });\n        })\n    });\n}\n\nif (window.locationWatcher) {\n    // clear existing watcher otherwise we'll have duplicates\n    window.locationWatcher();\n}\n\n// ensure we only load the script once, seems to cause issues otherwise\nif (window.L) {\n    initMap();\n} else {\n    console.log('Loading Leaflet library');\n    var sc = document.createElement('script');\n    sc.type = 'text/javascript';\n    sc.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js';\n    sc.onload = initMap;\n    sc.onerror = function(err) { alert(err); }\n    document.getElementsByTagName('head')[0].appendChild(sc);\n}\n</script>"}]},"apps":[],"jobName":"paragraph_1566825207620_2050925033","id":"20190826-131327_1398279067","dateCreated":"2019-08-26T13:13:27+0000","dateStarted":"2019-09-09T12:18:07+0000","dateFinished":"2019-09-09T12:18:07+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:176"},{"text":"%md\n# A more complex example - Top Pickup and Dropoff locations for certain times of day\n\nNow that we have shown a simple example of a map, we will show a more complex example using a parameter-driven query with multiple map markers and layers.\n\nTo run this example:\n\n- Use the Query Parameters paragraph to choose the time frame for the query as well as how many of the Top pickup and dropoff stations to show on the map.\n- Then run the Query Parameters paragraph.  This will query the desired data (by automatically running the \"Spark code for the more complex map\" paragraph)\n- Once the data has been queried (takes about 20 seconds), the \"More Complex Map\" will be updated.  If the map is not showing, then play the \"More Complex Map\" paragraph to make it visible.\n-- Pickups are drawn in green.  Dropoffs are in red.\n-- Use the layers control in the upper right of the map to show/hide pickup and dropoff stations.\n-- The size of the circle on the map represents the number of pickups/dropoffs for that station during the selected time frame.","user":"anonymous","dateUpdated":"2019-08-26T13:43:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":"true"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>A more complex example - Top Pickup and Dropoff locations for certain times of day</h1>\n<p>Now that we have shown a simple example of a map, we will show a more complex example using a parameter-driven query with multiple map markers and layers.</p>\n<p>To run this example:</p>\n<ul>\n  <li>Use the Query Parameters paragraph to choose the time frame for the query as well as how many of the Top pickup and dropoff stations to show on the map.</li>\n  <li>Then run the Query Parameters paragraph. This will query the desired data (by automatically running the &ldquo;Spark code for the more complex map&rdquo; paragraph)</li>\n  <li>Once the data has been queried (takes about 20 seconds), the &ldquo;More Complex Map&rdquo; will be updated. If the map is not showing, then play the &ldquo;More Complex Map&rdquo; paragraph to make it visible.<br/>&ndash; Pickups are drawn in green. Dropoffs are in red.<br/>&ndash; Use the layers control in the upper right of the map to show/hide pickup and dropoff stations.<br/>&ndash; The size of the circle on the map represents the number of pickups/dropoffs for that station during the selected time frame.</li>\n</ul>\n</div>"}]},"apps":[],"jobName":"paragraph_1566827027699_-946479625","id":"20190826-134347_225739648","dateCreated":"2019-08-26T13:43:47+0000","dateStarted":"2019-08-26T13:43:50+0000","dateFinished":"2019-08-26T13:43:50+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:177"},{"text":"%spark\nz.angularBind(\"BIND_topN\", z.select(\"Top N\",\"10\",Seq((\"5\",\"5\"),(\"10\",\"10\"),(\"20\",\"20\"),(\"50\",\"50\"),(\"100\",\"100\"))))\nz.angularBind(\"BIND_dayOfWeek\", z.select(\"dayOfWeek\", \"All\", Seq((\"All\", \"All\"),\n                         (\"MonFri\", \"Mon-Fri\"), (\"SatSun\",\"Weekend\")))  )\nz.angularBind(\"BIND_hourOfDay\", z.select(\"hourOfDay\", \"All\", Seq((\"All\", \"All\"),\n                         (\"Morning\", \"7am to 10am\"), (\"Midday\",\"11am to 3pm\"),(\"Afternoon\",\"4pm to 7pm\"),\n                         (\"Evening\",\"8pm to 11pm\"),(\"LateNite\",\"12am to 6am\")))  )\n                         \nz.run(\"20190826-134402_1561120541\")                      \n\t\t\t\t\t\t ","user":"anonymous","dateUpdated":"2019-09-09T12:29:05+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala","editorHide":true},"settings":{"params":{"dayOfWeek":"MonFri","hourOfDay":"Afternoon","Top N":"20"},"forms":{"Top N":{"name":"Top N","displayName":"Top N","type":"select","defaultValue":"10","options":[{"value":"5","displayName":"5","$$hashKey":"object:1479"},{"value":"10","displayName":"10","$$hashKey":"object:1480"},{"value":"20","displayName":"20","$$hashKey":"object:1481"},{"value":"50","displayName":"50","$$hashKey":"object:1482"},{"value":"100","displayName":"100","$$hashKey":"object:1483"}],"hidden":false,"$$hashKey":"object:1454"},"dayOfWeek":{"name":"dayOfWeek","displayName":"dayOfWeek","type":"select","defaultValue":"All","options":[{"value":"All","displayName":"All","$$hashKey":"object:1464"},{"value":"MonFri","displayName":"Mon-Fri","$$hashKey":"object:1465"},{"value":"SatSun","displayName":"Weekend","$$hashKey":"object:1466"}],"hidden":false,"$$hashKey":"object:1452"},"hourOfDay":{"name":"hourOfDay","displayName":"hourOfDay","type":"select","defaultValue":"All","options":[{"value":"All","displayName":"All","$$hashKey":"object:1470"},{"value":"Morning","displayName":"7am to 10am","$$hashKey":"object:1471"},{"value":"Midday","displayName":"11am to 3pm","$$hashKey":"object:1472"},{"value":"Afternoon","displayName":"4pm to 7pm","$$hashKey":"object:1473"},{"value":"Evening","displayName":"8pm to 11pm","$$hashKey":"object:1474"},{"value":"LateNite","displayName":"12am to 6am","$$hashKey":"object:1475"}],"hidden":false,"$$hashKey":"object:1453"}}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1566827030163_1967639193","id":"20190826-134350_2038496199","dateCreated":"2019-08-26T13:43:50+0000","dateStarted":"2019-09-09T12:29:05+0000","dateFinished":"2019-09-09T12:29:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:178"},{"text":"%md\n\nThis cell gives us the capability to update the map after new settings have been chosen. If you look at the code, we are using `z.run`and the cell ID to automatically run the cell after. The cell ID can be found via the settings button/gear wheel. \n\n\nChoose the desired settings and press run to update the map below. \n","user":"anonymous","dateUpdated":"2019-09-09T12:28:49+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":"true"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1568031811680_-694895462","id":"20190909-122331_1779557593","dateCreated":"2019-09-09T12:23:31+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1045","dateFinished":"2019-09-09T12:28:49+0000","dateStarted":"2019-09-09T12:28:49+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>This cell gives us the capability to update the map after new settings have been chosen. If you look at the code, we are using <code>z.run</code>and the cell ID to automatically run the cell after. The cell ID can be found via the settings button/gear wheel. </p>\n<p>Choose the desired settings and press run to update the map below.</p>\n</div>"}]}},{"text":"%spark\n\n//Define a class for the structure of the data we will be passing to the map javascript code\ncase class Stations(ridetype: String, station: String, trips: String, lat: Double, lon: Double, radius: Double)\n\nz.angularUnbind(\"stations\")\n\n{\n//Be sure to have run Part 1 prior to running this as this assumes that the bike_trips table is part of your current session\n\n//Define some UI widgets for data selection parameters\n// Learn more here: https://zeppelin.apache.org/docs/0.6.1/interpreter/spark.html#form-creation\n\n\n//Use our UI values to define custom SQL\nvar limitString = \" limit \"+z.angular(\"BIND_topN\")\nvar whereString = \" where 1=1 \"\n\nif (z.angular(\"BIND_dayOfWeek\")==\"MonFri\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"E\") in (\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\") \"\"\"\n} else if (z.angular(\"BIND_dayOfWeek\")==\"SatSun\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"E\") in (\"Sat\",\"Sun\") \"\"\"\n}\n\nif (z.angular(\"BIND_hourOfDay\")==\"Morning\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"H\") in (\"7\",\"8\",\"9\",\"10\") \"\"\"\n} else if (z.angular(\"BIND_hourOfDay\")==\"Midday\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"H\") in (\"11\",\"12\",\"13\",\"14\",\"15\") \"\"\"\n} else if (z.angular(\"BIND_hourOfDay\")==\"Afternoon\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"H\") in (\"16\",\"17\",\"18\",\"19\") \"\"\"\n} else if (z.angular(\"BIND_hourOfDay\")==\"Evening\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"H\") in (\"20\",\"21\",\"22\",\"23\") \"\"\"\n} else if (z.angular(\"BIND_hourOfDay\")==\"LateNite\") {\n    whereString = whereString+ s\"\"\" AND date_format(`Start Time`,\"H\") in (\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\") \"\"\"\n}\n\nprintln(\"WHERE STRING: \"+whereString)\n\n//Define a new dataframe based off a query\nvar stations = spark.sql(s\"\"\"select \"Start\" ridetype, `Start Station Name` station,`Start Station Latitude` lat,`Start Station Longitude` lon, count(*) trips from bike_trips_temp \"\"\" +\nwhereString + s\"\"\"\ngroup by `Start Station Name`,`Start Station Latitude`,`Start Station Longitude`\norder by count(*) desc \"\"\" + limitString)\n\n\n//Map the DF into an Array of Stations\nvar items1 = stations.map(b => Stations(b(0).toString, b(1).toString, \"Pickups:\"+b(4).toString, b(2).toString.toDouble, b(3).toString.toDouble,  b(4).toString.toDouble/8 )).collect\n\n\n\n//now do the same for top ending stations\nstations = spark.sql(s\"\"\"select \"End\" ridetype, `End Station Name` station,`End Station Latitude` lat,`End Station Longitude` lon, count(*) trips from bike_trips_temp \"\"\" +\nwhereString + s\"\"\"\ngroup by `End Station Name`,`End Station Latitude`,`End Station Longitude`\norder by count(*) desc \"\"\" + limitString)\n\t\n//Map the DF into an Array of Stations.  Offset the lat,lon by a bit so you see both Start and End markers\nvar items2 = stations.map(b => Stations(b(0).toString, b(1).toString, \"Dropoffs:\"+b(4).toString, b(2).toString.toDouble+0.0001, b(3).toString.toDouble+0.0001, b(4).toString.toDouble/8)).collect\n\n//combine the two arrays\nval combined=items1 ++ items2\n\n//Bind the Stations to an Angular variable named stations\nz.angularBind(\"stations\", combined) \n\nprintln(\"done\")\n}\n","user":"anonymous","dateUpdated":"2019-09-09T12:28:58+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"editOnDblClick":"true","language":"scala"},"editorMode":"ace/mode/scala","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\ndefined class Stations\nWHERE STRING:  where 1=1  AND date_format(`Start Time`,\"E\") in (\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\")  AND date_format(`Start Time`,\"H\") in (\"16\",\"17\",\"18\",\"19\") \ndone\n"}]},"apps":[],"jobName":"paragraph_1566827042037_549454747","id":"20190826-134402_1561120541","dateCreated":"2019-08-26T13:44:02+0000","dateStarted":"2019-09-09T12:29:06+0000","dateFinished":"2019-09-09T12:29:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:179"},{"text":"%md\n\nThe scala code above will take the desired settings above and will query accordingly. Then we will bind the results to angular in order to display the results on the map. \n","user":"anonymous","dateUpdated":"2019-09-09T12:26:22+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":"true"},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1568031880883_-972391364","id":"20190909-122440_1005023650","dateCreated":"2019-09-09T12:24:40+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1114","dateFinished":"2019-09-09T12:26:22+0000","dateStarted":"2019-09-09T12:26:22+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>The scala code above will take the desired settings above and will query accordingly. Then we will bind the results to angular in order to display the results on the map.</p>\n</div>"}]}},{"text":"%angular\n<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css\" />\n<div id=\"map\" style=\"height: 600px; width: 100%\"></div>\n\n<script type=\"text/javascript\">\n\n//based on https://gist.github.com/granturing/a09aed4a302a7367be92, https://community.hortonworks.com/articles/90320/add-leaflet-map-to-zeppelin-notebook.html, etc\n\nfunction initMap() {\n    //open up a map around NYC at zoom level 13\n    var map = L.map('map', {preferCanvas: true}).setView([40.75, -73.99], 13);\n\n    //define the background tile layer using OpenStreet maps.  Leaflet can work with other providers, too\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: 'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors',\n        maxZoom: 16,\n        minZoom: 11\n    }).addTo(map);\n\n    //define a new LayerGroup which will hold our markers\n    var startMarkers = L.layerGroup().addTo(map);\n    var endMarkers = L.layerGroup().addTo(map);\n\n    var overlayMaps = {\n    \"Top Pickup Stations\": startMarkers,\n    \"Top Dropoff Stations\": endMarkers\n    };\n    \n    //add a Control to the map to let the user click the Marker layer off and on\n    L.control.layers(null, overlayMaps).addTo(map);\n    \n    // keep track of our markers, so we can remove them later\n    var markers = new Array();\n    \n    // setup a custom icon for markers. See https://github.com/pointhi/leaflet-color-markers\n    var greenIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n    \n    var redIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n\n    var el = angular.element($('#map').parent('.ng-scope'));\n    angular.element(el).ready(function() {\n        \n        //listen for changes to the angular variable called stations\n        window.locationWatcher = el.scope().compiledScope.$watch('stations', function(newValue, oldValue) {\n             //startMarkers.clearLayers(); -- this did not work for me, so I use the for loop below to delete old markers\n            for(i=0;i<markers.length;i++) {\n               startMarkers.removeLayer(markers[i]);\n               endMarkers.removeLayer(markers[i]);\n               map.removeLayer(markers[i]);\n            }  \n            //now empty our array and start again\n            markers = new Array();\n            \n            //loop through each entry in our stations variable and add it as a marker\n            angular.forEach(newValue, function(bikes) {\n                var marker = L.marker([bikes.lat, bikes.lon], {icon: greenIcon})\n                    .bindPopup(\"<b>\" + bikes.station + \"</b><br>\" + bikes.trips)\n                var circle = L.circle([bikes.lat, bikes.lon], bikes.radius,{\n                       color: 'green',\n                       fillColor: '#5f0',\n                       fillOpacity: 0.5 })\n                   \n                if (bikes.ridetype==\"End\") {\n                    marker.setIcon(redIcon)\n                    marker.addTo(endMarkers)\n                    circle.setStyle({\n                       color: 'red',\n                       fillColor: '#f03',\n                       fillOpacity: 0.5 })\n                    circle.addTo(endMarkers)\n                } else {\n                    marker.addTo(startMarkers);  \n                    circle.addTo(startMarkers);  \n                }\n                markers.push(circle);   \n                markers.push(marker);   \n\n            });\n        })\n    });\n}\n\nif (window.locationWatcher) {\n    // clear existing watcher otherwise we'll have duplicates\n    window.locationWatcher();\n}\n\n// ensure we only load the script once, seems to cause issues otherwise\nif (window.L) {\n    initMap();\n} else {\n    console.log('Loading Leaflet library');\n    var sc = document.createElement('script');\n    sc.type = 'text/javascript';\n    sc.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js';\n    sc.onload = initMap;\n    sc.onerror = function(err) { alert(err); }\n    document.getElementsByTagName('head')[0].appendChild(sc);\n}\n</script>\n","user":"anonymous","dateUpdated":"2019-09-09T12:18:52+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":"true"},"editorMode":"ace/mode/undefined","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"ANGULAR","data":"<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css\" />\n<div id=\"map\" style=\"height: 600px; width: 100%\"></div>\n\n<script type=\"text/javascript\">\n\n//based on https://gist.github.com/granturing/a09aed4a302a7367be92, https://community.hortonworks.com/articles/90320/add-leaflet-map-to-zeppelin-notebook.html, etc\n\nfunction initMap() {\n    //open up a map around NYC at zoom level 13\n    var map = L.map('map', {preferCanvas: true}).setView([40.75, -73.99], 13);\n\n    //define the background tile layer using OpenStreet maps.  Leaflet can work with other providers, too\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: 'Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors',\n        maxZoom: 16,\n        minZoom: 11\n    }).addTo(map);\n\n    //define a new LayerGroup which will hold our markers\n    var startMarkers = L.layerGroup().addTo(map);\n    var endMarkers = L.layerGroup().addTo(map);\n\n    var overlayMaps = {\n    \"Top Pickup Stations\": startMarkers,\n    \"Top Dropoff Stations\": endMarkers\n    };\n    \n    //add a Control to the map to let the user click the Marker layer off and on\n    L.control.layers(null, overlayMaps).addTo(map);\n    \n    // keep track of our markers, so we can remove them later\n    var markers = new Array();\n    \n    // setup a custom icon for markers. See https://github.com/pointhi/leaflet-color-markers\n    var greenIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n    \n    var redIcon = new L.Icon({\n      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [12, 20],\n      iconAnchor: [6, 20],\n      popupAnchor: [1, -17],\n      shadowSize: [20, 20]\n    });\n\n    var el = angular.element($('#map').parent('.ng-scope'));\n    angular.element(el).ready(function() {\n        \n        //listen for changes to the angular variable called stations\n        window.locationWatcher = el.scope().compiledScope.$watch('stations', function(newValue, oldValue) {\n             //startMarkers.clearLayers(); -- this did not work for me, so I use the for loop below to delete old markers\n            for(i=0;i<markers.length;i++) {\n               startMarkers.removeLayer(markers[i]);\n               endMarkers.removeLayer(markers[i]);\n               map.removeLayer(markers[i]);\n            }  \n            //now empty our array and start again\n            markers = new Array();\n            \n            //loop through each entry in our stations variable and add it as a marker\n            angular.forEach(newValue, function(bikes) {\n                var marker = L.marker([bikes.lat, bikes.lon], {icon: greenIcon})\n                    .bindPopup(\"<b>\" + bikes.station + \"</b><br>\" + bikes.trips)\n                var circle = L.circle([bikes.lat, bikes.lon], bikes.radius,{\n                       color: 'green',\n                       fillColor: '#5f0',\n                       fillOpacity: 0.5 })\n                   \n                if (bikes.ridetype==\"End\") {\n                    marker.setIcon(redIcon)\n                    marker.addTo(endMarkers)\n                    circle.setStyle({\n                       color: 'red',\n                       fillColor: '#f03',\n                       fillOpacity: 0.5 })\n                    circle.addTo(endMarkers)\n                } else {\n                    marker.addTo(startMarkers);  \n                    circle.addTo(startMarkers);  \n                }\n                markers.push(circle);   \n                markers.push(marker);   \n\n            });\n        })\n    });\n}\n\nif (window.locationWatcher) {\n    // clear existing watcher otherwise we'll have duplicates\n    window.locationWatcher();\n}\n\n// ensure we only load the script once, seems to cause issues otherwise\nif (window.L) {\n    initMap();\n} else {\n    console.log('Loading Leaflet library');\n    var sc = document.createElement('script');\n    sc.type = 'text/javascript';\n    sc.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js';\n    sc.onload = initMap;\n    sc.onerror = function(err) { alert(err); }\n    document.getElementsByTagName('head')[0].appendChild(sc);\n}\n</script>"}]},"apps":[],"jobName":"paragraph_1566827169636_-2145559701","id":"20190826-134609_2097075969","dateCreated":"2019-08-26T13:46:09+0000","dateStarted":"2019-09-09T12:18:52+0000","dateFinished":"2019-09-09T12:18:52+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:180"},{"text":"%angular\n","user":"anonymous","dateUpdated":"2019-08-26T13:46:48+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":"true"},"editorMode":"ace/mode/undefined"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1566827208838_-145573621","id":"20190826-134648_223391488","dateCreated":"2019-08-26T13:46:48+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:181"}],"name":"Workshop/03_Map","id":"2EM5JDTNK","angularObjects":{"2EMSN6FPW:shared_process":[],"2EKEZF3UV:shared_process":[],"2EJK98C7R:shared_process":[],"2EKACAX51:shared_process":[],"2EK77FQSB:shared_process":[],"2ENRU88WV:shared_process":[],"2EMU1N182:shared_process":[],"2C4U48MY3_spark2:shared_process":[{"name":"BIND_topN","object":"20","noteId":"2EM5JDTNK"},{"name":"BIND_dayOfWeek","object":"SatSun","noteId":"2EM5JDTNK"},{"name":"topstations","object":[{"ridetype":"Start","station":"Pershing Square North","trips":"Pickups:9642","lat":40.751873,"lon":-73.977706},{"ridetype":"Start","station":"W 21 St & 6 Ave","trips":"Pickups:5990","lat":40.74173969,"lon":-73.99415556},{"ridetype":"Start","station":"E 17 St & Broadway","trips":"Pickups:5802","lat":40.73704984,"lon":-73.99009296},{"ridetype":"Start","station":"Broadway & E 22 St","trips":"Pickups:5420","lat":40.7403432,"lon":-73.98955109},{"ridetype":"Start","station":"Broadway & E 14 St","trips":"Pickups:5342","lat":40.73454567,"lon":-73.99074142},{"ridetype":"Start","station":"8 Ave & W 33 St","trips":"Pickups:5282","lat":40.751551,"lon":-73.993934},{"ridetype":"Start","station":"W 41 St & 8 Ave","trips":"Pickups:4963","lat":40.75640548,"lon":-73.9900262},{"ridetype":"Start","station":"W 52 St & 5 Ave","trips":"Pickups:4822","lat":40.75992262,"lon":-73.97648516},{"ridetype":"Start","station":"Cooper Square & E 7 St","trips":"Pickups:4644","lat":40.72923649910006,"lon":-73.99086803197861},{"ridetype":"Start","station":"8 Ave & W 31 St","trips":"Pickups:4622","lat":40.7505853470215,"lon":-73.9946848154068}],"noteId":"2EM5JDTNK"},{"name":"BIND_hourOfDay","object":"Morning","noteId":"2EM5JDTNK"},{"name":"stations","object":[{"ridetype":"Start","station":"9 Ave & W 22 St","trips":"Pickups:200","lat":40.7454973,"lon":-74.00197139,"radius":25},{"ridetype":"Start","station":"W 21 St & 6 Ave","trips":"Pickups:152","lat":40.74173969,"lon":-73.99415556,"radius":19},{"ridetype":"Start","station":"E 20 St & FDR Drive","trips":"Pickups:152","lat":40.73314259,"lon":-73.97573881,"radius":19},{"ridetype":"Start","station":"Greenwich Ave & 8 Ave","trips":"Pickups:148","lat":40.7390169121,"lon":-74.0026376103,"radius":18.5},{"ridetype":"Start","station":"1 Ave & E 16 St","trips":"Pickups:141","lat":40.73221853,"lon":-73.98165557,"radius":17.625},{"ridetype":"Start","station":"1 Ave & E 18 St","trips":"Pickups:138","lat":40.733812191966315,"lon":-73.98054420948029,"radius":17.25},{"ridetype":"Start","station":"E 10 St & Avenue A","trips":"Pickups:131","lat":40.72740794,"lon":-73.98142006,"radius":16.375},{"ridetype":"Start","station":"Amsterdam Ave & W 73 St","trips":"Pickups:128","lat":40.77966809007312,"lon":-73.98093044757842,"radius":16},{"ridetype":"Start","station":"Henry St & Grand St","trips":"Pickups:128","lat":40.714215,"lon":-73.981346,"radius":16},{"ridetype":"Start","station":"11 Ave & W 41 St","trips":"Pickups:128","lat":40.76030096,"lon":-73.99884222,"radius":16},{"ridetype":"Start","station":"W 47 St & 10 Ave","trips":"Pickups:126","lat":40.76269882,"lon":-73.99301222,"radius":15.75},{"ridetype":"Start","station":"E 7 St & Avenue A","trips":"Pickups:126","lat":40.72621788,"lon":-73.98379855,"radius":15.75},{"ridetype":"Start","station":"W 41 St & 8 Ave","trips":"Pickups:121","lat":40.75640548,"lon":-73.9900262,"radius":15.125},{"ridetype":"Start","station":"E 6 St & Avenue B","trips":"Pickups:120","lat":40.72453734,"lon":-73.98185424,"radius":15},{"ridetype":"Start","station":"1 Ave & E 78 St","trips":"Pickups:120","lat":40.77140426,"lon":-73.9535166,"radius":15},{"ridetype":"Start","station":"E 9 St & Avenue C","trips":"Pickups:118","lat":40.72521311,"lon":-73.97768752,"radius":14.75},{"ridetype":"Start","station":"W 15 St & 7 Ave","trips":"Pickups:118","lat":40.73935542,"lon":-73.99931783,"radius":14.75},{"ridetype":"Start","station":"Carmine St & 6 Ave","trips":"Pickups:117","lat":40.73038599,"lon":-74.00214988,"radius":14.625},{"ridetype":"Start","station":"E 17 St & Broadway","trips":"Pickups:115","lat":40.73704984,"lon":-73.99009296,"radius":14.375},{"ridetype":"Start","station":"Central Park S & 6 Ave","trips":"Pickups:115","lat":40.76590936,"lon":-73.97634151,"radius":14.375},{"ridetype":"End","station":"W 21 St & 6 Ave","trips":"Dropoffs:272","lat":40.741839690000006,"lon":-73.99405555999999,"radius":34},{"ridetype":"End","station":"E 17 St & Broadway","trips":"Dropoffs:234","lat":40.73714984,"lon":-73.98999296,"radius":29.25},{"ridetype":"End","station":"W 20 St & 11 Ave","trips":"Dropoffs:199","lat":40.746845,"lon":-74.007656,"radius":24.875},{"ridetype":"End","station":"Greenwich Ave & 8 Ave","trips":"Dropoffs:182","lat":40.7391169121,"lon":-74.0025376103,"radius":22.75},{"ridetype":"End","station":"Broadway & E 22 St","trips":"Dropoffs:172","lat":40.7404432,"lon":-73.98945109,"radius":21.5},{"ridetype":"End","station":"Broadway & E 14 St","trips":"Dropoffs:165","lat":40.734645670000006,"lon":-73.99064142,"radius":20.625},{"ridetype":"End","station":"W 18 St & 6 Ave","trips":"Dropoffs:164","lat":40.739813010000006,"lon":-73.99446404999999,"radius":20.5},{"ridetype":"End","station":"Broadway & W 60 St","trips":"Dropoffs:163","lat":40.769255050000005,"lon":-73.98181841,"radius":20.375},{"ridetype":"End","station":"Grand St & Elizabeth St","trips":"Dropoffs:155","lat":40.718922000000006,"lon":-73.99586,"radius":19.375},{"ridetype":"End","station":"Central Park S & 6 Ave","trips":"Dropoffs:151","lat":40.766009360000005,"lon":-73.97624151,"radius":18.875},{"ridetype":"End","station":"Pershing Square North","trips":"Dropoffs:150","lat":40.75197300000001,"lon":-73.977606,"radius":18.75},{"ridetype":"End","station":"Amsterdam Ave & W 73 St","trips":"Dropoffs:144","lat":40.77976809007313,"lon":-73.98083044757841,"radius":18},{"ridetype":"End","station":"Great Jones St","trips":"Dropoffs:142","lat":40.72753423,"lon":-73.99369025,"radius":17.75},{"ridetype":"End","station":"E 15 St & 3 Ave","trips":"Dropoffs:141","lat":40.734332,"lon":-73.986823,"radius":17.625},{"ridetype":"End","station":"Cooper Square & E 7 St","trips":"Dropoffs:141","lat":40.729336499100064,"lon":-73.9907680319786,"radius":17.625},{"ridetype":"End","station":"Grand Army Plaza & Central Park S","trips":"Dropoffs:139","lat":40.7644971,"lon":-73.97361465,"radius":17.375},{"ridetype":"End","station":"Carmine St & 6 Ave","trips":"Dropoffs:136","lat":40.730485990000005,"lon":-74.00204988,"radius":17},{"ridetype":"End","station":"Lafayette St & Jersey St","trips":"Dropoffs:132","lat":40.724405272503326,"lon":-73.99590982666015,"radius":16.5},{"ridetype":"End","station":"W 63 St & Broadway","trips":"Dropoffs:126","lat":40.771738510000006,"lon":-73.98251428,"radius":15.75},{"ridetype":"End","station":"Cleveland Pl & Spring St","trips":"Dropoffs:118","lat":40.72220378668604,"lon":-73.99714900722503,"radius":14.75}],"noteId":"2EM5JDTNK"}]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}